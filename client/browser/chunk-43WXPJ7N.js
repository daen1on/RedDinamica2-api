import{a as k}from"./chunk-L5TQBNKQ.js";import{H as y,S as o,Sb as s,Vb as _,W as f,Z as m,a as u,b as p,ga as T,k as c,t as l,x as g}from"./chunk-3BHHYQXT.js";var z=(()=>{class a{constructor(t){this._http=t,this.profilePictureUpdated=new T,this.url=k.url,this._identity=this.loadIdentityFromStorage(),this._token=this.loadTokenFromStorage(),this.identityChanged=new c(this._identity)}register(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json"});return this._http.post(this.url+"register",e,{headers:i})}registerByAdmin(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.post(this.url+"registerbyAdmin",e,{headers:i})}signup(t,e=null){e!=null&&(t.getToken=!0);let i=JSON.stringify(t),n=new s({"Content-Type":"application/json"});return this._http.post(this.url+"login",i,{headers:n}).pipe(o(r=>{r.user&&this.setIdentity(r.user),r.token&&this.setToken(r.token)}))}updateUser(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.put(this.url+"user-update/"+t._id,e,{headers:i}).pipe(o(n=>{n.user&&this._identity&&n.user._id===this._identity._id&&this.setIdentity(n.user)}))}activateUserByAdmin(t){let e=p(u({},t),{actived:!0}),i=JSON.stringify(e),n=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.put(this.url+"user-update/"+t._id,i,{headers:n})}validatePass(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.post(this.url+"validate-password",e,{headers:i})}changePass(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.post(this.url+"change-password",e,{headers:i})}recoverPass(t){let e=JSON.stringify(t),i=new s({"Content-Type":"application/json"});return this._http.post(this.url+"recover-password",e,{headers:i})}resetPassword(t,e){let i=JSON.stringify({token:t,newPassword:e}),n=new s({"Content-Type":"application/json"});return this._http.post(this.url+"reset-password",i,{headers:n})}getMyPreferences(){let t=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(`${this.url}users/me/preferences`,{headers:t})}updateMyPreferences(t){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.put(`${this.url}users/me/preferences`,t,{headers:e}).pipe(o(i=>{i?.user&&this.setIdentity(i.user)}))}getUsers(t=null){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(this.url+"users/"+t,{headers:e})}getAllUsers(){let t=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(this.url+"all-users/",{headers:t})}searchUsers(t,e=8){let i=new s({"Content-Type":"application/json",Authorization:this.getToken()||""}),n=Date.now(),r=`?q=${encodeURIComponent(t)}&limit=${e}&_ts=${n}`,d=this.url+"users/search"+r;return console.log("[UserService] searchUsers request",{q:t,limit:e,ts:n,url:d}),this._http.get(d,{headers:i}).pipe(o({next:h=>console.log("[UserService] searchUsers response",{q:t,limit:e,ts:n,count:h?.users?.length}),error:h=>console.error("[UserService] searchUsers error",{q:t,limit:e,ts:n,err:h})}))}getNewUsers(t=null){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(this.url+"new-users/"+t,{headers:e})}deleteUser(t=null){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return t?this._http.delete(this.url+"user/"+t,{headers:e}):this._http.delete(this.url+"user",{headers:e})}getUser(t){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(this.url+"user/"+t,{headers:e})}getStats(){let t=JSON.parse(localStorage.getItem("stats"));t!="undefined"?this.stats=t:this.stats=null}getCounters(t=null){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return t?this._http.get(this.url+"counters/"+t,{headers:e}):this._http.get(this.url+"counters",{headers:e})}loadIdentityFromStorage(){let t=localStorage.getItem("identity");return t?JSON.parse(t):null}loadTokenFromStorage(){return localStorage.getItem("token")}getIdentity(){let t=localStorage.getItem("identity");if(!t&&this._identity)return this._identity=null,this.identityChanged.next(null),null;if(t&&!this._identity)try{this._identity=JSON.parse(t),this.identityChanged.next(this._identity)}catch(e){console.error("Error parsing identity from localStorage:",e),localStorage.removeItem("identity"),this._identity=null,this.identityChanged.next(null)}return this._identity}getToken(){let t=localStorage.getItem("token");return!t&&this._token?(this._token=null,this._identity=null,this.identityChanged.next(null),setTimeout(()=>this.checkAndRedirectIfNeeded(),100),null):(t&&!this._token&&(this._token=t),this._token)}setIdentity(t){this._identity=t,t?localStorage.setItem("identity",JSON.stringify(t)):localStorage.removeItem("identity"),this.identityChanged.next(this._identity)}setToken(t){this._token=t,t?localStorage.setItem("token",t):localStorage.removeItem("token"),this.identityChanged.next(this._identity)}clearIdentityAndToken(){localStorage.removeItem("identity"),localStorage.removeItem("token"),this._identity=null,this._token=null,this.identityChanged.next(null)}forceUserLogout(t){let e=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.post(this.url+"force-logout/"+t,{},{headers:e})}uploadProfileImage(t,e){let i=new FormData;i.append("image",e,e.name);let n=new s({Authorization:this.getToken()||""});return this._http.post(`${this.url}upload-image-user/${t}`,i,{headers:n}).pipe(o(r=>{r.user&&(this.setIdentity(r.user),this.profilePictureUpdated.emit())}))}isTokenValid(){let t=this.getToken(),e=this.getIdentity();return!(!t||!e||t.length<20)}checkAndRedirectIfNeeded(){let t=window.location.pathname;["/admin","/perfil","/home","/lecciones","/mensajes"].some(n=>t.startsWith(n))&&this.handleExpiredSession("Su sesi\xF3n ha expirado. Por favor, inicie sesi\xF3n nuevamente.")}handleExpiredSession(t){let i=t||"Su sesi\xF3n ha expirado. Por favor, inicie sesi\xF3n nuevamente.";this.clearIdentityAndToken(),sessionStorage.clear(),localStorage.clear(),alert(i),window.location.href="/login"}checkTokenStatus(){if(!this.isTokenValid())return l(!1);let t=new s({"Content-Type":"application/json",Authorization:this.getToken()||""});return this._http.get(`${this.url}verify-token`,{headers:t}).pipe(g(e=>e&&e.valid===!0),y(e=>(console.log("Token verification failed:",e),(e.status===401||e.status===403)&&this.handleExpiredSession(),l(!1))))}static{this.\u0275fac=function(e){return new(e||a)(m(_))}}static{this.\u0275prov=f({token:a,factory:a.\u0275fac})}}return a})();export{z as a};
