import{a as Re}from"./chunk-HD7OORPX.js";import{a as Ee,b as Me,c as Te,d as Se,e as Ie,f as Oe}from"./chunk-D2BCPON4.js";import{a as ke}from"./chunk-RHRI3TQF.js";import{b as we}from"./chunk-QSZSAD22.js";import{a as G}from"./chunk-43WXPJ7N.js";import{a as Ce}from"./chunk-L5TQBNKQ.js";import{C as ve,c as de,d as F,e as ue,f as _e,m as fe,q as be,r as ge,z as he}from"./chunk-GWDAXWU7.js";import{A as Z,Ba as q,D as J,Da as a,Fa as T,H as k,Ib as ce,J as K,Jb as me,Na as s,Oa as l,Pa as d,Q as X,R as x,Rb as pe,S as Q,Ta as C,Ua as h,Va as c,W as D,Ya as oe,Z as ee,Za as re,a as B,aa as te,b as H,ba as b,bc as xe,ca as g,cc as ye,db as ae,eb as _,ec as Pe,fb as L,ga as A,gb as E,hb as j,j as $,ja as ie,k as Y,ma as z,na as I,nb as se,ob as S,pa as r,sa as w,sb as P,t as y,ta as ne,tb as U,u as W,ub as O,vb as le,ya as u}from"./chunk-3BHHYQXT.js";var Le=(()=>{class n{constructor(){this.observer=null,this.visibleItems=new Map,this.visibilitySubject=new Y(new Map),this.visibilityChanges$=this.visibilitySubject.asObservable(),this.initializeObserver()}initializeObserver(){let e={root:null,rootMargin:"50px",threshold:[0,.1,.25,.5,.75,1]};this.observer=new IntersectionObserver(t=>{let i=!1;t.forEach(o=>{let p=o.target.getAttribute("data-viewport-id");if(!p)return;let f=o.isIntersecting&&o.intersectionRatio>.1,v=this.visibleItems.get(p);(!v||v.isVisible!==f||Math.abs(v.intersectionRatio-o.intersectionRatio)>.1)&&(this.visibleItems.set(p,{id:p,element:o.target,isVisible:f,intersectionRatio:o.intersectionRatio}),i=!0)}),i&&this.visibilitySubject.next(new Map(this.visibleItems))},e)}observeElement(e,t){if(!this.observer||!e){console.warn("Observer not initialized or element is null");return}e.setAttribute("data-viewport-id",t),this.visibleItems.set(t,{id:t,element:e,isVisible:!1,intersectionRatio:0}),this.observer.observe(e)}unobserveElement(e,t){!this.observer||!e||(this.observer.unobserve(e),this.visibleItems.delete(t),this.visibilitySubject.next(new Map(this.visibleItems)))}getVisibleItems(){return Array.from(this.visibleItems.values()).filter(e=>e.isVisible)}isElementVisible(e){let t=this.visibleItems.get(e);return t?t.isVisible:!1}getPartiallyVisibleItems(){return Array.from(this.visibleItems.values()).filter(e=>e.intersectionRatio>.25)}getFullyVisibleItems(){return Array.from(this.visibleItems.values()).filter(e=>e.intersectionRatio>.75)}clearAll(){this.observer&&this.observer.disconnect(),this.visibleItems.clear(),this.visibilitySubject.next(new Map)}destroy(){this.clearAll(),this.observer=null,this.visibilitySubject.complete()}getVisibilityStats(){let e=Array.from(this.visibleItems.values());return{total:e.length,visible:e.filter(t=>t.isVisible).length,partiallyVisible:e.filter(t=>t.intersectionRatio>.25).length,fullyVisible:e.filter(t=>t.intersectionRatio>.75).length}}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=D({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Ue=(()=>{class n{constructor(e){this.userService=e}isUserActivated(){let e=this.userService.getIdentity();return e?!!e.actived:!1}canViewPersonalInfo(){return this.isUserActivated()}canViewProfilePictures(){return this.isUserActivated()}canComment(){return this.isUserActivated()}canSendMessages(){return this.isUserActivated()}canAccessResources(){return this.isUserActivated()}canAccessLessons(){return this.isUserActivated()}canFollowUsers(){return this.isUserActivated()}canViewFullProfiles(){return this.isUserActivated()}canParticipateInCalls(){return this.isUserActivated()}canCreatePublications(){return!0}getGdprLimitationMessage(){return"Tu cuenta est\xE1 en proceso de activaci\xF3n. Por protecci\xF3n de datos (GDPR), tienes acceso limitado hasta que un administrador apruebe tu cuenta."}getCurrentRestrictions(){return this.isUserActivated()?[]:["No puedes acceder a recursos educativos","No puedes acceder a lecciones acad\xE9micas","No puedes comentar en publicaciones","No puedes enviar mensajes privados","No puedes ver informaci\xF3n personal de otros usuarios","No puedes ver fotos de perfil de otros usuarios","No puedes seguir a otros usuarios","No puedes participar en convocatorias de lecciones"]}static{this.\u0275fac=function(t){return new(t||n)(ee(G))}}static{this.\u0275prov=D({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var R=n=>["/perfil",n],je=()=>["/error","report-error"],Ge=n=>({category:"publication",publicationId:n});function Be(n,m){n&1&&d(0,"img",42)}function He(n,m){if(n&1&&d(0,"img",43),n&2){let e=c();a("src",e.url+"get-image-user/"+e.publication.user.picture,I)}}function Xe(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c();r(),j(" ",e.publication.user.name," ",e.publication.user.surname," ")}}function qe(n,m){n&1&&(s(0,"span",44),_(1,"Cargando usuario..."),l())}function Ye(n,m){if(n&1){let e=C();s(0,"button",45),h("click",function(){b(e);let i=c();return g(i.requestDelete())}),d(1,"i",46),l()}}function We(n,m){n&1&&(s(0,"span"),_(1,"Mostrar m\xE1s"),l())}function Ze(n,m){n&1&&(s(0,"span"),_(1,"Mostrar menos"),l())}function Je(n,m){if(n&1){let e=C();s(0,"div",47)(1,"button",48),h("click",function(){b(e);let i=c();return g(i.toggleContentExpansion())}),d(2,"i",49),u(3,We,2,0,"span",28)(4,Ze,2,0,"span",28),l()()}if(n&2){let e=c();r(2),T("fa-chevron-down",!e.isContentExpanded)("fa-chevron-up",e.isContentExpanded),r(),a("ngIf",!e.isContentExpanded),r(),a("ngIf",e.isContentExpanded)}}function Ke(n,m){if(n&1&&(s(0,"div",50),d(1,"img",51),l()),n&2){let e=c();r(),a("src",e.url+"get-image-post/"+e.publication.file,I)}}function Qe(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c();r(),L(e.publication.likesCount)}}function et(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c();r(),L(e.publication.comments.length)}}function tt(n,m){n&1&&(s(0,"div",52),d(1,"i",53),s(2,"small"),_(3,"Tu cuenta est\xE1 en proceso de activaci\xF3n. No puedes comentar hasta que un administrador apruebe tu cuenta (protecci\xF3n de datos GDPR)."),l()())}function it(n,m){n&1&&d(0,"img",54)}function nt(n,m){if(n&1&&d(0,"img",55),n&2){let e=c();a("src",e.url+"get-image-user/"+e.identity.picture,I)}}function ot(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c(2);r(),E(" de ",e.commentsPagination.totalComments," ")}}function rt(n,m){n&1&&(s(0,"div",65)(1,"span",66),d(2,"i",67),_(3," Nuevos comentarios "),l()())}function at(n,m){n&1&&d(0,"img",74)}function st(n,m){if(n&1&&d(0,"img",75),n&2){let e=c(2).$implicit,t=c(2);a("src",t.url+"get-image-user/"+e.user.picture,I)}}function lt(n,m){if(n&1&&(s(0,"a",5)(1,"div",34),u(2,at,1,0,"img",72)(3,st,1,1,"img",73),l()()),n&2){let e=c().$implicit;a("routerLink",S(3,R,e.user._id)),r(2),a("ngIf",!(e.user!=null&&e.user.picture)),r(),a("ngIf",e.user==null?null:e.user.picture)}}function ct(n,m){n&1&&(s(0,"div",34),d(1,"img",74),l())}function mt(n,m){if(n&1&&(s(0,"a",90),_(1),l()),n&2){let e=c(2).$implicit;a("routerLink",S(3,R,e.user._id)),r(),j(" ",e.user.name," ",e.user.surname," ")}}function pt(n,m){n&1&&(s(0,"span",44),_(1," Usuario no disponible "),l())}function dt(n,m){n&1&&(s(0,"span"),_(1,"Mostrar m\xE1s"),l())}function ut(n,m){n&1&&(s(0,"span"),_(1,"Mostrar menos"),l())}function _t(n,m){if(n&1){let e=C();s(0,"div",91)(1,"button",92),h("click",function(){b(e);let i=c(2).$implicit,o=c(2);return g(o.toggleCommentExpansion(i._id))}),d(2,"i",49),u(3,dt,2,0,"span",28)(4,ut,2,0,"span",28),l()()}if(n&2){let e=c(2).$implicit,t=c(2);r(2),T("fa-chevron-down",!t.expandedComments[e._id])("fa-chevron-up",t.expandedComments[e._id]),r(),a("ngIf",!t.expandedComments[e._id]),r(),a("ngIf",t.expandedComments[e._id])}}function ft(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c(2).$implicit;r(),L(e.likesCount)}}function bt(n,m){if(n&1&&(s(0,"span",15)(1,"small"),_(2),l()()),n&2){let e=c(2).$implicit,t=c(2);r(2),E("",t.getTotalRepliesCount(e)," respuesta(s)")}}function gt(n,m){if(n&1){let e=C();s(0,"button",93),h("click",function(){b(e);let i=c(2).$implicit,o=c(2);return g(o.deleteComment(i._id))}),d(1,"i",46),l()}}function ht(n,m){n&1&&d(0,"img",54)}function vt(n,m){if(n&1&&d(0,"img",55),n&2){let e=c(5);a("src",e.url+"get-image-user/"+e.identity.picture,I)}}function Ct(n,m){if(n&1){let e=C();s(0,"form",94),h("ngSubmit",function(){b(e);let i=c(2).$implicit,o=c(2);return g(o.onReplySubmit(i._id,o.publication._id))}),s(1,"div",11)(2,"div",33)(3,"div",95),u(4,ht,1,0,"img",35)(5,vt,1,1,"img",36),l()(),s(6,"div",9)(7,"div",37),d(8,"textarea",96),s(9,"button",39),d(10,"i",40),l(),s(11,"button",97),h("click",function(){b(e);let i=c(2).$implicit,o=c(2);return g(o.cancelReply(i._id))}),d(12,"i",98),l()()()()()}if(n&2){let e=c(2).$implicit,t=c(2);a("formGroup",t.replyForm),r(4),a("ngIf",!(t.identity!=null&&t.identity.picture)),r(),a("ngIf",t.identity==null?null:t.identity.picture),r(3),a("id","reply-textarea-"+e._id),q("maxlength",t.MAX_INPUT_LENGTH),r(),a("disabled",!t.replyForm.valid)}}function xt(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c(3).$implicit,t=c(2);r(),E(" Ver m\xE1s respuestas (",(t.repliesPagination[e._id]==null?null:t.repliesPagination[e._id].totalReplies)-((e.replies==null?null:e.replies.length)||0)," restantes) ")}}function yt(n,m){n&1&&(s(0,"span"),d(1,"i",101),_(2,"Cargando... "),l())}function Pt(n,m){if(n&1){let e=C();s(0,"div",47)(1,"button",99),h("click",function(){b(e);let i=c(2).$implicit,o=c(2);return g(o.loadMoreReplies(i._id))}),d(2,"i",100),u(3,xt,2,1,"span",28)(4,yt,3,0,"span",28),l()()}if(n&2){let e=c(2).$implicit,t=c(2);r(),a("disabled",t.repliesPagination[e._id]==null?null:t.repliesPagination[e._id].loading),r(2),a("ngIf",!(t.repliesPagination[e._id]!=null&&t.repliesPagination[e._id].loading)),r(),a("ngIf",t.repliesPagination[e._id]==null?null:t.repliesPagination[e._id].loading)}}function kt(n,m){n&1&&d(0,"img",74)}function wt(n,m){if(n&1&&d(0,"img",75),n&2){let e=c(2).$implicit,t=c(5);a("src",t.url+"get-image-user/"+e.user.picture,I)}}function Et(n,m){if(n&1&&(s(0,"a",5)(1,"div",95),u(2,kt,1,0,"img",72)(3,wt,1,1,"img",73),l()()),n&2){let e=c().$implicit;a("routerLink",S(3,R,e.user._id)),r(2),a("ngIf",!(e.user!=null&&e.user.picture)),r(),a("ngIf",e.user==null?null:e.user.picture)}}function Mt(n,m){n&1&&(s(0,"div",95),d(1,"img",74),l())}function Tt(n,m){if(n&1&&(s(0,"a",90),_(1),l()),n&2){let e=c(2).$implicit;a("routerLink",S(3,R,e.user._id)),r(),j(" ",e.user.name," ",e.user.surname," ")}}function St(n,m){n&1&&(s(0,"span",44),_(1," Usuario no disponible "),l())}function It(n,m){n&1&&(s(0,"span"),_(1,"Mostrar m\xE1s"),l())}function Ot(n,m){n&1&&(s(0,"span"),_(1,"Mostrar menos"),l())}function Rt(n,m){if(n&1){let e=C();s(0,"div",91)(1,"button",92),h("click",function(){b(e);let i=c(2).$implicit,o=c(5);return g(o.toggleReplyExpansion(i._id))}),d(2,"i",49),u(3,It,2,0,"span",28)(4,Ot,2,0,"span",28),l()()}if(n&2){let e=c(2).$implicit,t=c(5);r(2),T("fa-chevron-down",!t.expandedReplies[e._id])("fa-chevron-up",t.expandedReplies[e._id]),r(),a("ngIf",!t.expandedReplies[e._id]),r(),a("ngIf",t.expandedReplies[e._id])}}function At(n,m){if(n&1&&(s(0,"span"),_(1),l()),n&2){let e=c(2).$implicit;r(),L(e.likesCount)}}function Lt(n,m){if(n&1){let e=C();s(0,"button",112),h("click",function(){b(e);let i=c(2).$implicit,o=c(5);return g(o.deleteComment(i._id))}),d(1,"i",46),l()}}function Ut(n,m){if(n&1){let e=C();s(0,"div",9)(1,"div",106)(2,"div",107),u(3,Tt,2,5,"a",78)(4,St,2,0,"span",79),s(5,"small",15),_(6),P(7,"amFromUnix"),P(8,"amLocale"),P(9,"amDateFormat"),l()(),s(10,"div",108),d(11,"p",81),u(12,Rt,5,6,"div",82),l(),s(13,"div",109)(14,"div",16)(15,"button",26),h("click",function(){b(e);let i=c().$implicit,o=c(5);return g(o.toggleLikeComment(i._id))}),d(16,"i",27),u(17,At,2,1,"span",28),l(),s(18,"button",110),h("click",function(){b(e);let i=c().$implicit,o=c(5);return g(o.replyToComment(i._id))}),d(19,"i",85),s(20,"small"),_(21,"Responder"),l()()(),s(22,"div"),u(23,Lt,2,0,"button",111),l()()()()}if(n&2){let e=c().$implicit,t=c(5);r(3),a("ngIf",e.user._id),r(),a("ngIf",!e.user._id),r(2),E(" ",O(9,16,O(8,13,U(7,11,e.created_at),"es"),"LLL")," "),r(5),a("innerHTML",t.formatTextWithMentions(t.getDisplayReplyText(e)),z),r(),a("ngIf",t.shouldShowReplyExpand(e)),r(3),T("text-danger",t.hasUserLikedComment(e))("text-dark",!t.hasUserLikedComment(e)),r(2),a("ngIf",e.likesCount&&e.likesCount>0),r(6),a("ngIf",e.user&&e.user._id==t.identity._id)}}function Ft(n,m){if(n&1&&(s(0,"div",104)(1,"div",11)(2,"div",33),u(3,Et,4,5,"a",69)(4,Mt,2,0,"div",105),l(),u(5,Ut,24,19,"div",71),l()()),n&2){let e=m.$implicit;r(3),a("ngIf",e.user&&e.user._id),r(),a("ngIf",!e.user||!e.user._id),r(),a("ngIf",e.user)}}function Vt(n,m){if(n&1&&(s(0,"div",102),u(1,Ft,6,3,"div",103),l()),n&2){let e=c(2).$implicit;r(),a("ngForOf",e.replies)}}function Nt(n,m){if(n&1){let e=C();s(0,"div",9)(1,"div",76)(2,"div",77),u(3,mt,2,5,"a",78)(4,pt,2,0,"span",79),s(5,"small",15),_(6),P(7,"amFromUnix"),P(8,"amLocale"),P(9,"amDateFormat"),l()(),s(10,"div",80),d(11,"p",81),u(12,_t,5,6,"div",82),l(),s(13,"div",83)(14,"div",16)(15,"button",26),h("click",function(){b(e);let i=c().$implicit,o=c(2);return g(o.toggleLikeComment(i._id))}),d(16,"i",27),u(17,ft,2,1,"span",28),l(),s(18,"button",84),h("click",function(){b(e);let i=c().$implicit,o=c(2);return g(o.toggleReplyForm(i._id))}),d(19,"i",85),_(20," Responder "),l(),u(21,bt,3,1,"span",86),l(),s(22,"div"),u(23,gt,2,0,"button",87),l()()(),u(24,Ct,13,6,"form",88)(25,Pt,5,3,"div",22)(26,Vt,2,1,"div",89),l()}if(n&2){let e=c().$implicit,t=c(2);r(3),a("ngIf",e.user._id),r(),a("ngIf",!e.user._id),r(2),E(" ",O(9,20,O(8,17,U(7,15,e.created_at),"es"),"LLL")," "),r(5),a("innerHTML",t.formatTextWithMentions(t.getDisplayCommentText(e)),z),r(),a("ngIf",t.shouldShowCommentExpand(e)),r(3),T("text-danger",t.hasUserLikedComment(e))("text-dark",!t.hasUserLikedComment(e)),r(2),a("ngIf",e.likesCount&&e.likesCount>0),r(4),a("ngIf",t.getTotalRepliesCount(e)>0),r(2),a("ngIf",e.user&&e.user._id==t.identity._id),r(),a("ngIf",t.showReplyForm[e._id]),r(),a("ngIf",t.repliesPagination[e._id]==null?null:t.repliesPagination[e._id].hasMore),r(),a("ngIf",e.replies&&e.replies.length>0)}}function $t(n,m){if(n&1&&(s(0,"div",68)(1,"div",11)(2,"div",33),u(3,lt,4,5,"a",69)(4,ct,2,0,"div",70),l(),u(5,Nt,27,23,"div",71),l()()),n&2){let e=m.$implicit;r(3),a("ngIf",e.user&&e.user._id),r(),a("ngIf",!e.user||!e.user._id),r(),a("ngIf",e.user)}}function Dt(n,m){if(n&1&&(s(0,"span"),d(1,"i",100),_(2),l()),n&2){let e=c(3);r(2),E(" Ver m\xE1s comentarios (",e.commentsPagination.totalComments-e.publication.comments.length," restantes) ")}}function zt(n,m){n&1&&(s(0,"span"),d(1,"i",101),_(2,"Cargando comentarios... "),l())}function jt(n,m){if(n&1){let e=C();s(0,"div",113)(1,"button",114),h("click",function(){b(e);let i=c(2);return g(i.loadMoreComments())}),u(2,Dt,3,1,"span",28)(3,zt,3,0,"span",28),l()()}if(n&2){let e=c(2);r(),a("disabled",e.commentsPagination.loading),r(),a("ngIf",!e.commentsPagination.loading),r(),a("ngIf",e.commentsPagination.loading)}}function Gt(n,m){if(n&1){let e=C();s(0,"div",56)(1,"div",57)(2,"small",58),d(3,"i",59),_(4),u(5,ot,2,1,"span",28),_(6,") "),l(),s(7,"div",16),u(8,rt,4,0,"div",60),s(9,"button",61),h("click",function(){b(e);let i=c();return g(i.forceUpdateComments())}),d(10,"i",62),l()()(),u(11,$t,6,3,"div",63)(12,jt,4,3,"div",64),l()}if(n&2){let e=c();r(4),E(" Comentarios (",e.publication.comments.length," "),r(),a("ngIf",e.commentsPagination.totalComments>e.publication.comments.length),r(3),a("ngIf",e.hasNewComments),r(3),a("ngForOf",e.publication.comments),r(),a("ngIf",e.commentsPagination.hasMore)}}var di=(()=>{class n{constructor(e,t,i,o,p,f,v,V){this._userService=e,this._publicationService=t,this._commentService=i,this._router=o,this.fb=p,this.elementRef=f,this.viewportService=v,this.gdprRestrictions=V,this.showDeleteButton=!0,this.enableRealTimeUpdates=!0,this.onDelete=new A,this.onDeleteComment=new A,this.onError=new A,this.onNewComment=new A,this.focusPublication="",this.showReplyForm={},this.loadingReplies={},this.replyingTo={},this.hasNewComments=!1,this.lastCommentCount=0,this.unsubscribe$=new $,this.pollTimer$=new $,this.isPollingActive=!1,this.pollingSubscription=null,this.isInViewport=!1,this.viewportObserverActive=!1,this.commentsPagination={currentPage:1,hasMore:!1,loading:!1,totalComments:0},this.repliesPagination={},this.isContentExpanded=!1,this.MAX_CONTENT_LENGTH=300,this.expandedComments={},this.expandedReplies={},this.MAX_COMMENT_DISPLAY_LENGTH=150,this.MAX_INPUT_LENGTH=2e3,this.url=Ce.url,this.createForms()}canUserComment(){return this.gdprRestrictions.canComment()}ngOnInit(){this.enrichPublicationUserData(),this.initializeLastCommentCount(),this.startRealTimePolling()}ngOnDestroy(){if(this.isPollingActive=!1,this.pollingSubscription&&(this.pollingSubscription.unsubscribe(),this.pollingSubscription=null),this.pollTimer$.next(),this.pollTimer$.complete(),this.viewportObserverActive&&this.publication&&this.publication._id){let e=this.elementRef.nativeElement;e&&this.viewportService.unobserveElement(e,this.publication._id)}this.unsubscribe$.next(),this.unsubscribe$.complete()}ngOnChanges(e){e.publication&&(this.enrichPublicationUserData(),this.initializeLastCommentCount(),this.checkAndInitializePagination())}checkAndInitializePagination(){if(this.publication&&this.publication.pagination)this.initializeCommentsPagination(this.publication.pagination.totalComments,this.publication.pagination.loadedComments);else if(this.publication&&this.publication.comments){let e=this.publication.comments.length,t=e===10,i=t?e+10:e;this.commentsPagination={currentPage:1,hasMore:t,loading:!1,totalComments:i}}else this.commentsPagination={currentPage:1,hasMore:!1,loading:!1,totalComments:0}}ngAfterViewInit(){this.enableRealTimeUpdates&&this.publication&&this.publication._id&&this.initializeViewportDetection()}initializeLastCommentCount(){this.lastCommentCount=this.getTotalCommentsCount()}initializeViewportDetection(){if(!this.publication||!this.publication._id)return;let e=this.publication._id;setTimeout(()=>{let t=this.elementRef.nativeElement;t&&(this.viewportService.observeElement(t,e),this.viewportObserverActive=!0,this.viewportService.visibilityChanges$.pipe(x(this.unsubscribe$),K(300),J(i=>i.has(e))).subscribe(i=>{let o=i.get(e);if(o){let p=this.isInViewport;this.isInViewport=o.isVisible,p!==this.isInViewport&&(this.isInViewport?(console.log(`Publication ${e} entered viewport - starting polling`),this.startRealTimePolling()):(console.log(`Publication ${e} left viewport - pausing polling`),this.pauseRealTimeUpdates()))}}))},100)}startRealTimePolling(){if(!(!this.enableRealTimeUpdates||this.isPollingActive)){if(this.viewportObserverActive&&!this.isInViewport){console.log("Skipping polling - publication not in viewport");return}this.isPollingActive=!0,this.pollingSubscription=Z(3e4,3e4).pipe(x(this.pollTimer$),x(this.unsubscribe$),X(()=>this.isPollingActive?this.fetchUpdatedComments():y(null)),k(e=>(console.error("Error in real-time polling:",e),y(null)))).subscribe({next:e=>{e&&this.isPollingActive&&this.processUpdatedComments(e)},error:e=>{console.error("Polling subscription error:",e),this.isPollingActive=!1},complete:()=>{this.isPollingActive=!1}})}}fetchUpdatedComments(){let e=this._userService.getToken();return!e||!this.publication._id||!this.isPollingActive?y(null):this.viewportObserverActive&&!this.isInViewport?(console.log("Skipping fetch - publication not visible"),y(null)):this._publicationService.getPublication(e,this.publication._id).pipe(k(t=>(console.error("Error fetching updated comments:",t),y(null))))}processUpdatedComments(e){if(!e||!e.publication)return;let t=e.publication,i=this.getTotalCommentsCount(),o=this.getTotalCommentsCountFromData(t);o>i?(this.hasNewComments=!0,this.lastCommentCount=o,this.onNewComment.emit({publicationId:this.publication._id,newCommentsCount:o-i}),this.updateCommentsGradually(t.comments)):o<i&&(this.publication.comments=t.comments,this.lastCommentCount=o),this.updateLikesAndCounts(t)}updateCommentsGradually(e){if(!e||e.length===0)return;if(Object.values(this.showReplyForm).some(i=>i)){console.log("Skipping comment update - reply forms are active");return}this.publication.comments=[...e],setTimeout(()=>{this.hasNewComments=!1},3e3)}updateLikesAndCounts(e){e.likes&&(this.publication.likes=e.likes),e.likesCount!==void 0&&(this.publication.likesCount=e.likesCount)}getTotalCommentsCount(){if(!this.publication.comments)return 0;let e=this.publication.comments.length;for(let t of this.publication.comments)e+=this.getTotalRepliesCount(t);return e}getTotalCommentsCountFromData(e){if(!e.comments)return 0;let t=e.comments.length;for(let i of e.comments)t+=this.getTotalRepliesCount(i);return t}pauseRealTimeUpdates(){this.isPollingActive=!1,this.pollTimer$.next(),this.pollingSubscription&&(this.pollingSubscription.unsubscribe(),this.pollingSubscription=null)}resumeRealTimeUpdates(){this.isPollingActive||(this.pollTimer$=new $,this.startRealTimePolling())}forceUpdateComments(){if(console.log("Force update requested. Polling active:",this.isPollingActive),!this.publication||!this.publication._id){console.log("No publication ID available for force update");return}let e=this._userService.getToken();if(!e){console.log("No token available for force update");return}this._publicationService.getPublication(e,this.publication._id).pipe(x(this.unsubscribe$),k(t=>(console.error("Error forcing comment update:",t),this.onError.emit("Error al actualizar comentarios"),y(null)))).subscribe({next:t=>{console.log("Force update response:",t),t&&t.publication&&t.publication.comments?(this.processUpdatedComments(t),console.log("Comments updated successfully")):(console.log("Invalid response, preserving current comments"),t||this.onError.emit("No se pudo obtener la informaci\xF3n actualizada"))},error:t=>{console.error("Force update failed:",t),this.onError.emit("Error al actualizar comentarios")}})}enrichPublicationUserData(){this.publication.likesCount||(this.publication.likesCount=this.publication.likes?this.publication.likes.length:0),this.publication.comments&&Array.isArray(this.publication.comments)&&this.publication.comments.forEach(e=>{e&&(e.likesCount||(e.likesCount=e.likes?e.likes.length:0),(!e.user||typeof e.user=="string")&&(typeof e.user=="string"?this.loadUserDataForComment(e,e.user):e.user={_id:null,name:"Usuario",surname:"no disponible",picture:null}),e.replies&&Array.isArray(e.replies)&&e.replies.forEach(t=>{t&&(t.likesCount||(t.likesCount=t.likes?t.likes.length:0),(!t.user||typeof t.user=="string")&&(typeof t.user=="string"?this.loadUserDataForComment(t,t.user):t.user={_id:null,name:"Usuario",surname:"no disponible",picture:null}))}))}),this.publication&&typeof this.publication.user=="string"&&this._userService.getUser(this.publication.user).pipe(x(this.unsubscribe$)).subscribe({next:e=>{e&&e.user?this.publication.user=e.user:(console.error("Failed to get user data for publication"),this.publication.user={_id:this.publication.user,name:"Usuario",surname:"no disponible",picture:null})},error:e=>{console.error("Error fetching publication user data:",e),this.publication.user={_id:this.publication.user,name:"Usuario",surname:"no disponible",picture:null}}})}loadUserDataForComment(e,t){this._userService.getUser(t).pipe(x(this.unsubscribe$)).subscribe({next:i=>{i&&i.user?e.user=i.user:(console.error("Failed to get user data for comment"),e.user={_id:t,name:"Usuario",surname:"no disponible",picture:null})},error:i=>{console.error("Error fetching comment user data:",i),e.user={_id:t,name:"Usuario",surname:"no disponible",picture:null}}})}createForms(){this.commentForm=this.fb.group({text:["",[F.required,F.maxLength(this.MAX_INPUT_LENGTH)]]}),this.replyForm=this.fb.group({text:["",[F.required,F.maxLength(this.MAX_INPUT_LENGTH)]]})}hasUserLikedPublication(e){if(!e||!this.identity||!this.identity._id||!e.likes||!Array.isArray(e.likes))return!1;let t=String(this.identity._id);return e.likes.some(o=>{let p;return typeof o=="object"&&o._id?p=String(o._id):p=String(o),p===t})}toggleLikePublication(e){let t=this._userService.getToken();if(!t){this.onError.emit("Debes iniciar sesi\xF3n para dar me gusta.");return}this._publicationService.toggleLikePublication(t,e).pipe(x(this.unsubscribe$),k(i=>(console.error("Error toggling publication like:",i),this.onError.emit("Error al procesar el me gusta. Int\xE9ntalo de nuevo."),y(null)))).subscribe({next:i=>{if(i&&i.action){let o=i.action==="liked",p=String(this.identity._id);this.publication.likes||(this.publication.likes=[]),o?this.hasUserLikedPublication(this.publication)||this.publication.likes.push(this.identity._id):this.publication.likes=this.publication.likes.filter(f=>{let v;return typeof f=="object"&&f._id?v=String(f._id):v=String(f),v!==p}),this.publication.likesCount=this.publication.likes.length}else console.error("Invalid response:",i)},error:i=>{console.error("Error in like subscription:",i)}})}hasUserLikedComment(e){if(!e||!this.identity||!this.identity._id||!e.likes||!Array.isArray(e.likes))return!1;let t=String(this.identity._id);return e.likes.some(i=>i?typeof i=="object"&&i._id?String(i._id)===t:String(i)===t:!1)}toggleLikeComment(e){if(!e)return;let t=this._userService.getToken();if(!t){this.onError.emit("Debes iniciar sesi\xF3n para dar me gusta.");return}this._commentService.toggleLikeComment(t,e).pipe(x(this.unsubscribe$),k(i=>(console.error("Error toggling comment like:",i),this.onError.emit("Error al procesar el me gusta del comentario. Int\xE9ntalo de nuevo."),y(null)))).subscribe({next:i=>{i&&i.action?this.updateCommentLikeStatus(e,i.action==="liked"):console.error("Invalid comment like response:",i)},error:i=>{console.error("Error in comment like subscription:",i)}})}updateCommentLikeStatus(e,t){if(!this.publication||!this.publication.comments||!e)return;let i=this.publication.comments.find(o=>o&&o._id===e);if(i)this.updateSingleCommentLike(i,t);else for(let o of this.publication.comments)if(o&&o.replies&&Array.isArray(o.replies)){let p=o.replies.find(f=>f&&f._id===e);if(p){this.updateSingleCommentLike(p,t);break}}}updateSingleCommentLike(e,t){if(!e||!this.identity||!this.identity._id)return;e.likes||(e.likes=[]);let i=String(this.identity._id);t?e.likes.some(p=>p?typeof p=="object"&&p._id?String(p._id)===i:String(p)===i:!1)||e.likes.push(this.identity._id):e.likes=e.likes.filter(o=>{if(!o)return!1;let p;return typeof o=="object"&&o._id?p=String(o._id):p=String(o),p!==i}),e.likesCount=e.likes.length}setFocusPublication(e){this.focusPublication=e}onCommentSubmit(e){if(!this.commentForm.valid||!e||!this.identity)return;if(!this.canUserComment()){this.onError.emit("Tu cuenta a\xFAn no ha sido activada. No puedes comentar hasta que un administrador apruebe tu cuenta (protecci\xF3n de datos GDPR).");return}let t=new Re(this.commentForm.value.text,this.identity._id,e);this._commentService.addComment(this._userService.getToken(),t).pipe(x(this.unsubscribe$),X(i=>{if(!i||!i.comment||!i.comment._id)throw new Error("Failed to add the comment");return this._publicationService.updatePublicationComments(this._userService.getToken(),e,i.comment).pipe(Q(o=>{if(o&&o.publication){let p={_id:this.identity._id||null,name:this.identity.name||"Usuario",surname:this.identity.surname||"An\xF3nimo",picture:this.identity.picture||null},f=H(B({},i.comment),{user:p,likes:[],likesCount:0,replies:[]});this.publication.comments||(this.publication.comments=[]),this.publication.comments.push(f),this.commentForm.reset(),this.focusPublication="",console.log("Comment successfully linked to publication")}else throw new Error("Failed to link comment to publication")}))}),k(i=>(console.error("Comment submission error:",i),this.onError.emit("Error al enviar el comentario. Int\xE9ntalo de nuevo."),W(()=>new Error("Failed to submit the comment"))))).subscribe({next:()=>console.log("Comment submitted and linked successfully"),error:i=>console.error("Comment submission failed",i)})}scrollToComments(e){this.setFocusPublication(e),setTimeout(()=>{let t=document.querySelector(`#comments-form-${e}`);if(t){t.scrollIntoView({behavior:"smooth",block:"center"});let i=t.querySelector("textarea");i&&i.focus()}},100)}toggleReplyForm(e){if(this.showReplyForm[e]=!this.showReplyForm[e],this.showReplyForm[e]){let t=this.findCommentById(e);if(t&&t.user&&t.user.name&&t.user.surname){this.replyingTo[e]=t.user;let o=!this.findRootComment(t),p="";o?p=`@${t.user.name} ${t.user.surname} `:p=`@${t.user.name} ${t.user.surname} `,this.replyForm.patchValue({text:p}),setTimeout(()=>{let f=document.querySelector(`#reply-textarea-${e}`);f&&(f.focus(),f.setSelectionRange(p.length,p.length))},100)}else this.replyForm.patchValue({text:""})}else this.replyForm.reset(),this.replyingTo[e]=null}replyToComment(e){let t=this.findCommentById(e);if(!t)return;let i=this.findRootComment(t)||t;if(this.showReplyForm[i._id]=!0,t.user&&t.user.name&&t.user.surname){this.replyingTo[i._id]=t.user;let o=`@${t.user.name} ${t.user.surname} `;this.replyForm.patchValue({text:o}),setTimeout(()=>{let p=document.querySelector(`#reply-textarea-${i._id}`);p&&(p.focus(),p.setSelectionRange(o.length,o.length))},100)}}onReplySubmit(e,t){if(!this.replyForm.valid)return;if(!this.canUserComment()){this.onError.emit("Tu cuenta a\xFAn no ha sido activada. No puedes responder comentarios hasta que un administrador apruebe tu cuenta (protecci\xF3n de datos GDPR).");return}this.pauseRealTimeUpdates();let i=this.replyForm.value.text,o=this.replyingTo[e],p=this.findCommentById(e);if(!p){this.onError.emit("No se pudo encontrar el comentario."),this.resumeRealTimeUpdates();return}let f=this.findRootComment(p),v={text:i,publication:t,mentionedUser:o&&o._id?o._id:null},V=f?f._id:e;this._commentService.addReply(this._userService.getToken(),V,v).pipe(x(this.unsubscribe$),k(M=>(console.error("Error adding reply:",M),this.onError.emit("Error al enviar la respuesta. Int\xE9ntalo de nuevo."),this.resumeRealTimeUpdates(),y(null)))).subscribe({next:M=>{if(M&&M.reply){let N=f||p;if(N){N.replies||(N.replies=[]);let Ne=H(B({},M.reply),{mentionedUser:o,user:M.reply.user||{_id:this.identity._id,name:this.identity.name,surname:this.identity.surname,picture:this.identity.picture},likes:[],likesCount:0,replies:[]});N.replies.push(Ne),this.replyForm.reset(),this.showReplyForm[e]=!1,this.replyingTo[e]=null,console.log("Reply added successfully to root comment")}}setTimeout(()=>{this.resumeRealTimeUpdates()},2e3)},error:M=>{console.error("Reply submission failed:",M),this.resumeRealTimeUpdates()}})}findRootComment(e){if(!this.publication||!this.publication.comments||!e)return null;let t=this.publication.comments.find(i=>i&&i._id===e._id);if(t)return t;for(let i of this.publication.comments)if(i&&i.replies&&Array.isArray(i.replies)&&this.findReplyById(i.replies,e._id))return i;return null}findCommentById(e){if(!this.publication||!this.publication.comments||!e)return null;for(let t of this.publication.comments)if(t&&t._id===e)return t;for(let t of this.publication.comments)if(t&&t.replies&&Array.isArray(t.replies)){let i=this.findReplyById(t.replies,e);if(i)return i}return null}findReplyById(e,t){if(!e||!Array.isArray(e)||!t)return null;for(let i of e)if(i&&i._id===t)return i;return null}getTotalRepliesCount(e){if(!e||!e.replies||!Array.isArray(e.replies))return 0;let t=e.replies.length;for(let i of e.replies)i&&(t+=this.getTotalRepliesCount(i));return t}cancelReply(e){this.showReplyForm[e]=!1,this.replyForm.reset(),this.replyingTo[e]=null}requestDelete(){this.onDelete.emit(this.publication._id)}deleteComment(e){this.onDeleteComment.emit(e)}newLines(e){let t="";return e&&e.split(`
`).forEach(i=>{t+=`<p>${i}</p>`}),t}extractMentions(e){if(!e||typeof e!="string")return[];let t=/@([A-Za-zÀ-ÿ\s]+)/g,i=e.match(t);return i?i.map(o=>o.substring(1).trim()):[]}shouldShowExpandButton(){return this.publication?.text&&this.publication.text.length>this.MAX_CONTENT_LENGTH}getDisplayContent(){return this.publication?.text?this.isContentExpanded||this.publication.text.length<=this.MAX_CONTENT_LENGTH?this.publication.text:this.publication.text.substring(0,this.MAX_CONTENT_LENGTH)+"...":""}toggleContentExpansion(){this.isContentExpanded=!this.isContentExpanded}formatTextWithMentions(e){if(!e||typeof e!="string")return"";let t=/@([A-Za-zÀ-ÿ]+(?:\s+[A-Za-zÀ-ÿ]+)?)\b/g;return e.replace(t,(o,p)=>{let f=p.trim(),v=this.findUserByName(f);return v&&v._id?`<a href="/perfil/${v._id}" target="_blank" class="mention-link" title="Ver perfil de ${f}">@${f}</a>`:`<span class="mention-unknown" style="color: #007bff; font-weight: 600; background-color: #e8f4f8; padding: 2px 6px; border-radius: 4px; cursor: help;" title="Usuario mencionado: ${f}">@${f}</span>`})}shouldShowCommentExpand(e){return!!(e&&e.text&&e.text.length>this.MAX_COMMENT_DISPLAY_LENGTH)}getDisplayCommentText(e){return!e||!e.text?"":this.expandedComments[e._id]||e.text.length<=this.MAX_COMMENT_DISPLAY_LENGTH?e.text:e.text.substring(0,this.MAX_COMMENT_DISPLAY_LENGTH)+"..."}toggleCommentExpansion(e){this.expandedComments[e]=!this.expandedComments[e]}shouldShowReplyExpand(e){return!!(e&&e.text&&e.text.length>this.MAX_COMMENT_DISPLAY_LENGTH)}getDisplayReplyText(e){return!e||!e.text?"":this.expandedReplies[e._id]||e.text.length<=this.MAX_COMMENT_DISPLAY_LENGTH?e.text:e.text.substring(0,this.MAX_COMMENT_DISPLAY_LENGTH)+"..."}toggleReplyExpansion(e){this.expandedReplies[e]=!this.expandedReplies[e]}findUserByName(e){if(!e||!this.publication)return null;let t=e.toLowerCase().split(" ").filter(i=>i.length>0);if(this.publication.user&&this.matchesUserName(this.publication.user,t))return this.publication.user;if(this.publication.comments&&Array.isArray(this.publication.comments))for(let i of this.publication.comments){if(i&&i.user&&this.matchesUserName(i.user,t))return i.user;if(i.replies&&Array.isArray(i.replies)){for(let o of i.replies)if(o&&o.user&&this.matchesUserName(o.user,t))return o.user}}return null}matchesUserName(e,t){if(!e||!e.name||!e.surname)return!1;let i=e.name.toLowerCase().trim(),o=e.surname.toLowerCase().trim();if(t.length===1)return i===t[0]||o===t[0];if(t.length===2){let[p,f]=t;return i===p&&o===f||i===f&&o===p}return!1}loadReplies(e){}loadMoreComments(){this.commentsPagination.loading||!this.commentsPagination.hasMore||(this.commentsPagination.loading=!0,this.commentsPagination.currentPage++,this._publicationService.loadMoreComments(this._userService.getToken(),this.publication._id,this.commentsPagination.currentPage,10).pipe(x(this.unsubscribe$),k(e=>(console.error("Error loading more comments:",e),this.commentsPagination.loading=!1,this.commentsPagination.currentPage--,y(null)))).subscribe(e=>{e&&e.comments&&(this.publication.comments||(this.publication.comments=[]),this.publication.comments.push(...e.comments),this.commentsPagination.hasMore=e.pagination.hasMore,this.commentsPagination.totalComments=e.pagination.totalComments,e.comments.forEach(t=>{t.totalReplies>5&&(this.repliesPagination[t._id]={currentPage:1,hasMore:!0,loading:!1,totalReplies:t.totalReplies})})),this.commentsPagination.loading=!1}))}loadMoreReplies(e){this.repliesPagination[e]||(this.repliesPagination[e]={currentPage:1,hasMore:!0,loading:!1,totalReplies:0});let t=this.repliesPagination[e];t.loading||!t.hasMore||(t.loading=!0,t.currentPage++,this._publicationService.loadMoreReplies(this._userService.getToken(),e,t.currentPage,5).pipe(x(this.unsubscribe$),k(i=>(console.error("Error loading more replies:",i),t.loading=!1,t.currentPage--,y(null)))).subscribe(i=>{if(i&&i.replies){let o=this.findCommentById(e);o&&(o.replies||(o.replies=[]),o.replies.push(...i.replies),t.hasMore=i.pagination.hasMore,t.totalReplies=i.pagination.totalReplies)}t.loading=!1}))}initializeCommentsPagination(e,t){this.commentsPagination={currentPage:1,hasMore:t<e,loading:!1,totalComments:e},console.log("\u2705 Paginaci\xF3n inicializada:",{publicationId:this.publication._id,totalComments:e,loadedComments:t,hasMore:this.commentsPagination.hasMore}),this.publication.comments&&this.publication.comments.forEach(i=>{i.totalReplies&&i.totalReplies>5&&(this.repliesPagination[i._id]={currentPage:1,hasMore:!0,loading:!1,totalReplies:i.totalReplies})})}static{this.\u0275fac=function(t){return new(t||n)(w(G),w(ke),w(we),w(xe),w(he),w(ie),w(Le),w(Ue))}}static{this.\u0275cmp=ne({type:n,selectors:[["app-publication-card"]],inputs:{publication:"publication",identity:"identity",showDeleteButton:"showDeleteButton",enableRealTimeUpdates:"enableRealTimeUpdates"},outputs:{onDelete:"onDelete",onDeleteComment:"onDeleteComment",onError:"onError",onNewComment:"onNewComment"},features:[te],decls:51,vars:49,consts:[["userFallback",""],[1,"card","mb-3","shadow-sm"],[1,"card-body","p-3"],[1,"d-flex","align-items-start","mb-3"],[1,"flex-shrink-0","me-3"],[3,"routerLink"],[1,"profile-picture-container"],["class","profile-picture","src","assets/images/user-default.png","alt","Imagen por defecto",4,"ngIf"],["class","profile-picture","alt","Foto de perfil",3,"src",4,"ngIf"],[1,"flex-grow-1"],[1,"d-flex","justify-content-between","align-items-start"],[1,"d-flex","align-items-start"],[1,"mb-1"],[1,"text-primary","text-decoration-none","fw-bold","author-name",3,"routerLink"],[4,"ngIf","ngIfElse"],[1,"text-muted","ms-2"],[1,"d-flex","align-items-center"],["title","Denunciar publicaci\xF3n",1,"btn","btn-link","p-1","text-warning",3,"routerLink","queryParams"],[1,"fas","fa-exclamation-circle","fa-sm"],["class","btn btn-link p-1 text-secondary","title","Eliminar publicaci\xF3n",3,"click",4,"ngIf"],[1,"publication-content","mb-3"],[1,"publication-text",3,"innerHTML"],["class","mt-2",4,"ngIf"],["class","publication-image mt-2",4,"ngIf"],[1,"interaction-bar","d-flex","justify-content-between","align-items-center","mb-3"],[1,"interaction-buttons"],["title","Me gusta",1,"btn","btn-sm","interaction-btn",3,"click"],[1,"fas","fa-heart","me-1"],[4,"ngIf"],["title","Comentar",1,"btn","btn-sm","interaction-btn","text-primary","ms-3",3,"click"],[1,"fas","fa-comment","me-1"],["class","alert alert-warning d-flex align-items-center mb-3","role","alert",4,"ngIf"],[1,"comment-form","mb-3",3,"ngSubmit","formGroup","id"],[1,"flex-shrink-0","me-2"],[1,"comment-avatar"],["class","img-fluid rounded-circle","src","assets/images/user-default.png","alt","Tu avatar",4,"ngIf"],["class","img-fluid rounded-circle","alt","Tu avatar",3,"src",4,"ngIf"],[1,"input-group"],["formControlName","text","rows","2",1,"form-control","form-control-sm",3,"focus","placeholder","disabled"],["type","submit",1,"btn","btn-primary","btn-sm",3,"disabled"],[1,"fas","fa-paper-plane"],["class","comments-section",4,"ngIf"],["src","assets/images/user-default.png","alt","Imagen por defecto",1,"profile-picture"],["alt","Foto de perfil",1,"profile-picture",3,"src"],[1,"text-muted"],["title","Eliminar publicaci\xF3n",1,"btn","btn-link","p-1","text-secondary",3,"click"],[1,"fas","fa-trash","fa-sm"],[1,"mt-2"],[1,"btn","btn-link","btn-sm","text-primary","p-0",3,"click"],[1,"fas"],[1,"publication-image","mt-2"],["alt","Imagen de publicaci\xF3n",1,"img-fluid","rounded",3,"src"],["role","alert",1,"alert","alert-warning","d-flex","align-items-center","mb-3"],[1,"fas","fa-lock","me-2"],["src","assets/images/user-default.png","alt","Tu avatar",1,"img-fluid","rounded-circle"],["alt","Tu avatar",1,"img-fluid","rounded-circle",3,"src"],[1,"comments-section"],[1,"comments-header","mb-2","d-flex","justify-content-between","align-items-center"],[1,"text-primary","fw-bold"],[1,"fas","fa-comments","me-1"],["class","new-comments-notification me-2",4,"ngIf"],["title","Actualizar comentarios",1,"btn","btn-link","p-0","text-primary",3,"click"],[1,"fas","fa-sync-alt"],["class","comment-item mb-2",4,"ngFor","ngForOf"],["class","text-center mt-3",4,"ngIf"],[1,"new-comments-notification","me-2"],[1,"badge","bg-success"],[1,"fas","fa-bell","me-1"],[1,"comment-item","mb-2"],[3,"routerLink",4,"ngIf"],["class","comment-avatar",4,"ngIf"],["class","flex-grow-1",4,"ngIf"],["class","img-fluid rounded-circle","src","assets/images/user-default.png","alt","Avatar",4,"ngIf"],["class","img-fluid rounded-circle","alt","Avatar",3,"src",4,"ngIf"],["src","assets/images/user-default.png","alt","Avatar",1,"img-fluid","rounded-circle"],["alt","Avatar",1,"img-fluid","rounded-circle",3,"src"],[1,"comment-bubble"],[1,"comment-header"],["class","text-primary text-decoration-none fw-bold",3,"routerLink",4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"comment-text"],[1,"mb-1",3,"innerHTML"],["class","mt-1",4,"ngIf"],[1,"comment-actions","d-flex","justify-content-between","align-items-center"],["title","Responder",1,"btn","btn-sm","interaction-btn","text-primary","ms-2",3,"click"],[1,"fas","fa-reply","me-1"],["class","text-muted ms-2",4,"ngIf"],["class","btn btn-link p-0 text-secondary","title","Eliminar comentario",3,"click",4,"ngIf"],["class","reply-form mt-2",3,"formGroup","ngSubmit",4,"ngIf"],["class","replies-section mt-2",4,"ngIf"],[1,"text-primary","text-decoration-none","fw-bold",3,"routerLink"],[1,"mt-1"],[1,"btn","btn-link","btn-sm","p-0","text-primary",3,"click"],["title","Eliminar comentario",1,"btn","btn-link","p-0","text-secondary",3,"click"],[1,"reply-form","mt-2",3,"ngSubmit","formGroup"],[1,"reply-avatar"],["formControlName","text","rows","2","placeholder","Escribe una respuesta...",1,"form-control","form-control-sm",2,"font-size","13px",3,"id"],["type","button",1,"btn","btn-secondary","btn-sm","ms-1",3,"click"],[1,"fas","fa-times"],[1,"btn","btn-link","btn-sm","p-0","text-primary",3,"click","disabled"],[1,"fas","fa-chevron-down","me-1"],[1,"fas","fa-spinner","fa-spin","me-1"],[1,"replies-section","mt-2"],["class","reply-item mb-2",4,"ngFor","ngForOf"],[1,"reply-item","mb-2"],["class","reply-avatar",4,"ngIf"],[1,"reply-bubble"],[1,"reply-header"],[1,"reply-text"],[1,"reply-actions","d-flex","justify-content-between","align-items-center"],["title","Responder en el hilo principal",1,"btn","btn-sm","interaction-btn","text-secondary","ms-2",3,"click"],["class","btn btn-link p-0 text-secondary","title","Eliminar respuesta",3,"click",4,"ngIf"],["title","Eliminar respuesta",1,"btn","btn-link","p-0","text-secondary",3,"click"],[1,"text-center","mt-3"],[1,"btn","btn-outline-primary","btn-sm",3,"click","disabled"]],template:function(t,i){if(t&1){let o=C();s(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"a",5)(5,"div",6),u(6,Be,1,0,"img",7)(7,He,1,1,"img",8),l()()(),s(8,"div",9)(9,"div",10)(10,"div",11)(11,"h6",12)(12,"a",13),u(13,Xe,2,2,"span",14)(14,qe,2,0,"ng-template",null,0,le),l()(),s(16,"small",15),_(17),P(18,"amFromUnix"),P(19,"amLocale"),P(20,"amDateFormat"),l()(),s(21,"div",16)(22,"a",17),d(23,"i",18),l(),u(24,Ye,2,0,"button",19),l()()()(),s(25,"div",20),d(26,"div",21),P(27,"linky"),u(28,Je,5,6,"div",22)(29,Ke,2,1,"div",23),l(),s(30,"div",24)(31,"div",25)(32,"button",26),h("click",function(){return b(o),g(i.toggleLikePublication(i.publication._id))}),d(33,"i",27),u(34,Qe,2,1,"span",28),l(),s(35,"button",29),h("click",function(){return b(o),g(i.scrollToComments(i.publication._id))}),d(36,"i",30),u(37,et,2,1,"span",28),l()()(),u(38,tt,4,0,"div",31),s(39,"form",32),h("ngSubmit",function(){return b(o),g(i.onCommentSubmit(i.publication._id))}),s(40,"div",11)(41,"div",33)(42,"div",34),u(43,it,1,0,"img",35)(44,nt,1,1,"img",36),l()(),s(45,"div",9)(46,"div",37)(47,"textarea",38),h("focus",function(){return b(o),g(i.setFocusPublication(i.publication._id))}),l(),s(48,"button",39),d(49,"i",40),l()()()()(),u(50,Gt,13,5,"div",41),l()()}if(t&2){let o=ae(15);r(4),a("routerLink",S(42,R,(i.publication.user==null?null:i.publication.user._id)||i.publication.user)),r(2),a("ngIf",!(i.publication.user!=null&&i.publication.user.picture)),r(),a("ngIf",i.publication.user==null?null:i.publication.user.picture),r(5),a("routerLink",S(44,R,(i.publication.user==null?null:i.publication.user._id)||i.publication.user)),r(),a("ngIf",i.publication.user==null?null:i.publication.user.name)("ngIfElse",o),r(4),E(" ",O(20,37,O(19,34,U(18,32,i.publication.created_at),"es"),"LLL")," "),r(5),a("routerLink",se(46,je))("queryParams",S(47,Ge,i.publication._id)),r(2),a("ngIf",i.showDeleteButton&&i.identity._id==((i.publication.user==null?null:i.publication.user._id)||i.publication.user)),r(2),oe("innerHTML",i.newLines(U(27,40,i.getDisplayContent())),z),r(2),a("ngIf",i.shouldShowExpandButton()),r(),a("ngIf",i.publication.file),r(3),T("text-danger",i.hasUserLikedPublication(i.publication))("text-dark",!i.hasUserLikedPublication(i.publication)),r(2),a("ngIf",i.publication.likesCount&&i.publication.likesCount>0),r(3),a("ngIf",i.publication.comments&&i.publication.comments.length>0),r(),a("ngIf",!i.canUserComment()),r(),re("id","comments-form-",i.publication._id,""),a("formGroup",i.commentForm),r(),T("opacity-50",!i.canUserComment()),r(3),a("ngIf",!i.identity.picture),r(),a("ngIf",i.identity.picture),r(3),a("placeholder",i.canUserComment()?"Escribe un comentario...":"Comentarios deshabilitados")("disabled",!i.canUserComment()),q("maxlength",i.MAX_INPUT_LENGTH),r(),a("disabled",!i.commentForm.valid||i.focusPublication!=i.publication._id||!i.canUserComment()),r(2),a("ngIf",i.publication.comments&&i.publication.comments.length>0)}},dependencies:[pe,ce,me,ve,fe,de,ue,_e,be,ge,Pe,ye,Se,Ee,Me,Te,Oe,Ie],styles:['.card[_ngcontent-%COMP%]{border:1px solid #e9ecef;transition:box-shadow .2s ease-in-out;max-width:100%;overflow-x:hidden}.card-body[_ngcontent-%COMP%]{overflow-x:hidden;word-wrap:break-word}.card[_ngcontent-%COMP%]:hover{box-shadow:0 4px 8px #0000001a!important}.profile-picture-container[_ngcontent-%COMP%]{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid #e9ecef}.profile-picture[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.comment-avatar[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:50%;overflow:hidden;border:1px solid #e9ecef}.comment-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.reply-avatar[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid #e9ecef}.reply-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.publication-content[_ngcontent-%COMP%]{line-height:1.5}.publication-text[_ngcontent-%COMP%]{font-size:14px;color:#333}.publication-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:.5rem}.publication-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]:last-child{margin-bottom:0}.publication-image[_ngcontent-%COMP%]{text-align:center}.publication-image[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-height:400px;object-fit:cover}.interaction-bar[_ngcontent-%COMP%]{border-top:1px solid #f8f9fa;padding-top:.75rem}.interaction-btn[_ngcontent-%COMP%]{border:none;background:none;padding:.25rem .5rem;font-size:14px;transition:all .2s ease;color:#333!important}.interaction-btn[_ngcontent-%COMP%]:hover{background-color:#f8f9fa;border-radius:4px;transform:scale(1.05)}.interaction-btn.text-danger[_ngcontent-%COMP%]{color:#dc3545!important}.interaction-btn.text-danger[_ngcontent-%COMP%]:hover{background-color:#ffeaea;color:#c82333!important}.interaction-btn.text-dark[_ngcontent-%COMP%]{color:#333!important}.interaction-btn.text-dark[_ngcontent-%COMP%]:hover{background-color:#f8f9fa;color:#000!important}.interaction-btn.text-primary[_ngcontent-%COMP%]:hover{background-color:#e3f2fd}.comment-form[_ngcontent-%COMP%]{background-color:#f8f9fa;padding:.75rem;border-radius:8px;border:1px solid #e9ecef}.comment-form[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{border:1px solid #dee2e6;resize:none;font-size:14px}.comment-form[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{border-color:#0d6efd;box-shadow:0 0 0 .2rem #0d6efd40}.reply-form[_ngcontent-%COMP%]{background-color:#f1f3f4;padding:.5rem;border-radius:6px;border:1px solid #e1e5e9;margin-left:1rem}.reply-form[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{border:1px solid #dee2e6;resize:none;font-size:13px}.reply-form[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{border-color:#0d6efd;box-shadow:0 0 0 .15rem #0d6efd40}.comments-section[_ngcontent-%COMP%]{background-color:#fafafa;padding:.75rem;border-radius:8px;border:1px solid #f0f0f0;max-width:100%;overflow-x:hidden;word-wrap:break-word}.comments-header[_ngcontent-%COMP%]{border-bottom:1px solid #e9ecef;padding-bottom:.5rem}.comment-item[_ngcontent-%COMP%]{padding:.5rem 0;border-bottom:1px solid #f0f0f0}.comment-bubble[_ngcontent-%COMP%]{background-color:#fff;padding:.75rem;border-radius:12px;border:1px solid #e9ecef;max-width:100%;overflow-wrap:break-word;word-break:break-word}.comment-header[_ngcontent-%COMP%]{margin-bottom:.5rem}.comment-text[_ngcontent-%COMP%]{font-size:14px;color:#333;line-height:1.4;overflow-wrap:break-word;word-break:break-word;hyphens:auto}.comment-actions[_ngcontent-%COMP%]{margin-top:.5rem;padding-top:.5rem;border-top:1px solid #f8f9fa}.new-comments-notification[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeInPulse .5s ease-out}.new-comments-notification[_ngcontent-%COMP%]   .badge[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse 1.5s infinite}@keyframes _ngcontent-%COMP%_fadeInPulse{0%{opacity:0;transform:scale(.8)}50%{opacity:1;transform:scale(1.1)}to{opacity:1;transform:scale(1)}}@keyframes _ngcontent-%COMP%_pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}to{transform:scale(1)}}.mention[_ngcontent-%COMP%]{background-color:#e3f2fd;color:#1976d2;padding:2px 4px;border-radius:3px;font-weight:500;text-decoration:none;border:1px solid #bbdefb;transition:all .2s ease}.mention[_ngcontent-%COMP%]:hover{background-color:#bbdefb;color:#1565c0;cursor:pointer}.mention-link[_ngcontent-%COMP%]{background-color:#e8f4f8;color:#007bff!important;padding:2px 6px;border-radius:4px;font-weight:600;text-decoration:none!important;border:1px solid #b8daff;transition:all .3s ease;display:inline-block;margin:0 1px;position:relative}.mention-link[_ngcontent-%COMP%]:hover{background-color:#007bff;color:#fff!important;transform:translateY(-1px);box-shadow:0 3px 8px #007bff66;text-decoration:none!important;border-color:#0056b3}.mention-link[_ngcontent-%COMP%]:active{transform:translateY(0);box-shadow:0 1px 3px #007bff4d}.mention-link[_ngcontent-%COMP%]:after{content:" \\2197";font-size:.75em;opacity:.6;margin-left:2px;transition:opacity .3s ease}.mention-link[_ngcontent-%COMP%]:hover:after{opacity:1}.mention[_ngcontent-%COMP%]{background-color:#f8f9fa;color:#6c757d!important;padding:2px 6px;border-radius:4px;font-weight:500;border:1px solid #dee2e6;display:inline-block;margin:0 1px}.mention-unknown[_ngcontent-%COMP%]{background-color:#e8f4f8!important;color:#007bff!important;font-weight:600;padding:2px 6px;border-radius:4px;cursor:help;display:inline-block;margin:0 1px;border:1px solid #b8daff;transition:all .3s ease}.mention-unknown[_ngcontent-%COMP%]:hover{background-color:#d1ecf1!important;transform:translateY(-1px);box-shadow:0 2px 4px #007bff33}.replies-section[_ngcontent-%COMP%]{margin-left:1rem;border-left:3px solid #e3f2fd;padding-left:.75rem;background-color:#fafbfc;border-radius:0 8px 8px 0;margin-top:.5rem}.reply-item[_ngcontent-%COMP%]{padding:.4rem 0;border-bottom:1px solid #f0f0f0}.reply-item[_ngcontent-%COMP%]:last-child{border-bottom:none;padding-bottom:0}.reply-bubble[_ngcontent-%COMP%]{background-color:#f8f9fa;padding:.6rem;border-radius:10px;border:1px solid #dee2e6;position:relative;max-width:100%;overflow-wrap:break-word;word-break:break-word}.reply-bubble[_ngcontent-%COMP%]:before{content:"";position:absolute;left:-8px;top:10px;width:0;height:0;border-top:6px solid transparent;border-bottom:6px solid transparent;border-right:8px solid #f8f9fa}.reply-header[_ngcontent-%COMP%]{margin-bottom:.4rem}.reply-text[_ngcontent-%COMP%]{font-size:13px;color:#333;line-height:1.3;overflow-wrap:break-word;word-break:break-word;hyphens:auto}.reply-actions[_ngcontent-%COMP%]{margin-top:.4rem;padding-top:.4rem;border-top:1px solid #e9ecef}.interaction-btn.text-secondary[_ngcontent-%COMP%]{color:#6c757d!important;font-size:12px}.interaction-btn.text-secondary[_ngcontent-%COMP%]:hover{background-color:#e9ecef;color:#495057!important}.reply-text[_ngcontent-%COMP%]   .mention[_ngcontent-%COMP%]{background-color:#d1ecf1;color:#0c5460;font-weight:600}.comments-section[_ngcontent-%COMP%]{background-color:#fafafa;padding:.75rem;border-radius:8px;border:1px solid #f0f0f0;position:relative}.comment-item[_ngcontent-%COMP%]{padding:.5rem 0;border-bottom:1px solid #f0f0f0;position:relative}.comment-item[_ngcontent-%COMP%]:last-child{border-bottom:none;padding-bottom:0}.comment-item[_ngcontent-%COMP%]:has(.replies-section):after{content:"";position:absolute;left:16px;bottom:0;width:2px;height:10px;background-color:#e3f2fd}@media (max-width: 576px){.card-body[_ngcontent-%COMP%]{padding:1rem!important}.profile-picture-container[_ngcontent-%COMP%]{width:40px;height:40px}.comment-avatar[_ngcontent-%COMP%]{width:28px;height:28px}.reply-avatar[_ngcontent-%COMP%]{width:24px;height:24px}.publication-text[_ngcontent-%COMP%], .comment-text[_ngcontent-%COMP%]{font-size:13px}.replies-section[_ngcontent-%COMP%]{margin-left:.5rem;padding-left:.5rem;border-left-width:2px}.reply-bubble[_ngcontent-%COMP%]:before{left:-6px;border-right-width:6px}.reply-text[_ngcontent-%COMP%]{font-size:12px}.interaction-btn.text-secondary[_ngcontent-%COMP%]{font-size:11px}}.interaction-btn[_ngcontent-%COMP%]{transition:all .2s ease}.interaction-btn[_ngcontent-%COMP%]:active{transform:scale(.95)}.card[_ngcontent-%COMP%]{transition:transform .2s ease,box-shadow .2s ease}.reply-form[_ngcontent-%COMP%], .replies-section[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideIn .3s ease-out}@keyframes _ngcontent-%COMP%_slideIn{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}a.text-primary[_ngcontent-%COMP%]:hover{color:#0056b3!important;text-decoration:none}.btn-link.text-primary[_ngcontent-%COMP%]{text-decoration:none;font-weight:500;transition:all .2s ease}.btn-link.text-primary[_ngcontent-%COMP%]:hover{text-decoration:none;color:#0056b3!important;transform:translateY(-1px)}.btn-link.text-primary[_ngcontent-%COMP%]:focus{box-shadow:0 0 0 .2rem #0d6efd40}.btn-link[_ngcontent-%COMP%]   i.fas[_ngcontent-%COMP%]{transition:transform .3s ease}.btn-link[_ngcontent-%COMP%]:hover   i.fas[_ngcontent-%COMP%]{transform:scale(1.1)}.theme-dark[_nghost-%COMP%]   .author-name[_ngcontent-%COMP%], .theme-dark   [_nghost-%COMP%]   .author-name[_ngcontent-%COMP%]{color:#fff!important}']})}}return n})();var Fe=class{constructor(m,e){this.text=m,this.user=e,this.likes=[],this.likesCount=0}};var Ve=class{constructor(){}};export{Fe as a,di as b,Ve as c};
